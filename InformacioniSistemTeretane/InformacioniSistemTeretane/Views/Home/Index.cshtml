@using Microsoft.AspNetCore.Identity
@using InformacioniSistemTeretane.Models
@using InformacioniSistemTeretane.Data
@using Microsoft.EntityFrameworkCore
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext Context

@{
    ViewData["Title"] = "Početna stranica";
    
    var welcomeMessage = "Dobrodošli u GymChain IST";
    var userRole = "Gost";
    var userRoles = new List<string>();

    if (SignInManager.IsSignedIn(User)) 
    {
        var user = await UserManager.GetUserAsync(User);
        welcomeMessage = $"Dobrodošli, {user.UserName}!";
        
        // Dohvati sve uloge korisnika
        userRoles = (List<string>)await UserManager.GetRolesAsync(user);
        
        // Postavi statusnu poruku
        if (userRoles.Contains("Admin")) userRole = "Administrator";
        else if (userRoles.Contains("Zaposlenik")) userRole = "Zaposlenik";
        else if (userRoles.Contains("Trener")) userRole = "Trener";
        else if (userRoles.Contains("Sudija")) userRole = "Sudija";
        else if (userRoles.Contains("Klijent")) userRole = "Član teretane";
    }

    // Dohvatanje podataka za multimediju
    var featuredScreenshots = await Context.Screenshots
        .OrderByDescending(s => s.DatumKreiranja)
        .Take(3)
        .ToListAsync();
        
    var featuredVideo = await Context.VideoSadrzaji
        .OrderByDescending(v => v.DatumDodavanja)
        .FirstOrDefaultAsync();
        
    var gymLocations = await Context.Mape
        .ToListAsync();
}

<div class="welcome-banner bg-gradient-primary text-white text-center py-5 mb-4">
    <div class="container position-relative">
        <h1 class="display-4 fw-bold text-white">@welcomeMessage</h1>
        <div class="badge bg-white text-primary fs-6 mb-3 px-3 py-2 rounded-pill">
            Status: @userRole
        </div>
        <p class="lead mb-0">Sve što vam treba za upravljanje teretanom</p>
    </div>
</div>

<div class="container">
    <div class="row g-4">
        <!-- Provjera uloga pomoću userRoles liste -->
        @if (userRoles.Contains("Zaposlenik") || userRoles.Contains("Admin"))
        {
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Paketi" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-wallet2 fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Paketi</h5>
                        <p class="card-text small">Upravljanje članskim paketima</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Uplate" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-currency-dollar fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Članarine</h5>
                        <p class="card-text small">Evidencija uplata članarina</p>
                    </div>
                </a>
            </div>
        }

        @if (SignInManager.IsSignedIn(User)) {
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="GrupniTreninzi" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-people-fill fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Grupni treninzi</h5>
                        <p class="card-text small">Pregled grupnih treninga</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="PersonalniTreninzi" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-person-badge-fill fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Personalni treninzi</h5>
                        <p class="card-text small">Rezervacija personalnih treninga</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="ProbniTreninzi" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-clock-fill fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Probni treninzi</h5>
                        <p class="card-text small">Rezervacija probnih treninga</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Igraonice" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-controller fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Igraonice</h5>
                        <p class="card-text small">Pregled igraonica i opreme</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Takmicenja" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-trophy-fill fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Takmičenja</h5>
                        <p class="card-text small">Kalendar i prijave na takmičenja</p>
                    </div>
                </a>
            </div>
        }

        <!-- Provjera admin uloge pomoću userRoles liste -->
        @if (userRoles.Contains("Admin"))
        {
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Lokacije" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-geo-alt-fill fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Lokacije</h5>
                        <p class="card-text small">Upravljanje lokacijama teretana</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Sale" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-building fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Sale</h5>
                        <p class="card-text small">Upravljanje salama za treninge</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Zaposlenici" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-people fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Zaposlenici</h5>
                        <p class="card-text small">Evidencija zaposlenika</p>
                    </div>
                </a>
            </div>
            
            <div class="col-6 col-md-4 col-lg-3">
                <a asp-controller="Licence" asp-action="Index" class="card h-100 text-decoration-none custom-card">
                    <div class="card-body text-center p-3">
                        <div class="icon-wrapper bg-primary mb-3">
                            <i class="bi bi-award-fill fs-2 text-white"></i>
                        </div>
                        <h5 class="card-title fw-semibold">Licence</h5>
                        <p class="card-text small">Upravljanje licencama</p>
                    </div>
                </a>
            </div>
        }
    </div>

<!-- Sekcija za galeriju screenshotova -->
    @if (featuredScreenshots.Any())
    {
        <div class="feature-section mt-5">
            <div class="container">
                <h2 class="section-title">Naši Treninzi u Akciji</h2>
                <div class="row g-4">
                    @foreach (var screenshot in featuredScreenshots)
                    {
                        <div class="col-md-4">
                            <div class="card h-100 shadow-sm">
                                <img src="@screenshot.Opis" class="card-img-top" alt="@screenshot.Naziv" style="height: 250px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title">@screenshot.Naziv</h5>
                                    <p class="card-text text-muted small">
                                        <i class="fas fa-calendar-alt"></i> @screenshot.DatumKreiranja.ToString("dd.MM.yyyy")
                                    </p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="text-center mt-4">
                    <a asp-controller="Screenshots" asp-action="Index" class="btn btn-outline-primary">
                        <i class="fas fa-images me-1"></i> Pogledaj više slika
                    </a>
                </div>
            </div>
        </div>
    }

    <!-- Sekcija za video -->
    @if (featuredVideo != null)
    {
        <div class="feature-section">
            <div class="container">
                <h2 class="section-title">Promotivni Video</h2>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="embed-responsive embed-responsive-16by9">
                                <iframe class="embed-responsive-item" 
                                        src="https://www.youtube.com/embed/@featuredVideo.YouTubeVideoId" 
                                        allowfullscreen></iframe>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">@featuredVideo.Naziv</h5>
                                <p class="card-text">@featuredVideo.Opis</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <a asp-controller="Video" asp-action="Index" class="btn btn-outline-primary">
                        <i class="fas fa-video me-1"></i> Pogledaj više videa
                    </a>
                </div>
            </div>
        </div>
    }

    <!-- Sekcija za mape lokacija -->
    @if (gymLocations.Any())
    {
        <div class="feature-section mt-5">
            <div class="container">
                <h2 class="section-title">Naše Lokacije</h2>
                <div class="row">
                    <!-- Lijevi stupac: Leaflet mapa -->
                    <div class="col-md-6">
                        <div id="mapContainer" style="height: 400px; border-radius: 0.5rem; overflow: hidden;"></div>
                    </div>
                    <!-- Desni stupac: Popis svih lokacija s badgeovima u različitim bojama -->
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Sve dostupne lokacije</h5>
                                <ul class="list-group list-group-flush">
                                    @foreach (var location in gymLocations)
                                    {
                                        var badgeClass = location.Tip switch
                                        {
                                            TipMape.Teretana => "bg-primary",
                                            TipMape.Bazen => "bg-info",
                                            TipMape.ProstorZaTrening => "bg-success",
                                            TipMape.SportskiCentar => "bg-warning",
                                            _ => "bg-secondary"
                                        };
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">@location.Naziv</h6>
                                                <small class="text-muted">@location.Adresa</small>
                                            </div>
                                            <span class="badge @badgeClass rounded-pill">
                                                @Html.DisplayFor(m => location.Tip)
                                            </span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

@section Scripts {
    @if (gymLocations.Any())
    {
        <!-- 1) Uvoz Leaflet JS -->
        <script 
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-o9N1j7kS3zWZzS0hbnAw4ZlWx53A0M2K5l29I+o0mH0="
            crossorigin="">
        </script>

        <!-- 2) InitMap skripta -->
        <script>
            // Ovo pretvara stringani JSON iz ViewBag‐a u JS polje objekata
            const locations = @Html.Raw(ViewBag.gymLocations);

            function getTipNaziv(tip) {
                switch (tip) {
                    case 0: return 'Teretana';
                    case 1: return 'Bazeni';
                    case 2: return 'Prostor za trening';
                    case 3: return 'Sportski centar';
                    default: return 'Ostalo';
                }
            }

            function initMap() {
                // Zadana središnja pozicija (ako nema neke lokacije s vidljivim tipom)
                const defaultCenter = [44.2019, 17.9083];
                const zoomLevel = 13;

                // Kreiramo Leaflet mapu unutar div#mapContainer
                const map = L.map('mapContainer').setView(defaultCenter, zoomLevel);

                // Dodajemo OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Jedna ikona za sve (možete ih proširiti pa npr. razne tipove mapirati na razne ikone)
                const gymIcon = L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/619/619032.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                // Za svaku lokaciju (bilo kojeg tipa) dodaj marker
                locations.forEach(loc => {
                    const marker = L.marker([loc.latitude, loc.longitude], { icon: gymIcon }).addTo(map);

                    marker.bindPopup(`
                        <div class="map-popup">
                            <h6>${loc.naziv}</h6>
                            <p class="mb-1">${loc.adresa}</p>
                            <p class="text-muted small mb-0">
                                <i class="fas fa-map-marker-alt me-1"></i> ${getTipNaziv(loc.tip)}
                            </p>
                        </div>
                    `);
                });

                // Ako je samo jedna lokacija, zoomiraj dublje
                if (locations.length === 1) {
                    map.setView([locations[0].latitude, locations[0].longitude], 16);
                }

                // Ako lista ne sadrži “Politehnički fakultet Zenica”, dodajemo ga
                const hasPF = locations.some(l =>
                    l.naziv.includes("Politehnički") ||
                    (l.latitude === 44.2019 && l.longitude === 17.9083)
                );

                if (!hasPF) {
                    const pfMarker = L.marker(defaultCenter, { icon: gymIcon }).addTo(map);
                    pfMarker.bindPopup(`
                        <div class="map-popup">
                            <h6>Politehnički fakultet Zenica</h6>
                            <p class="mb-1">Zmaja od Bosne bb, 72000 Zenica</p>
                            <p class="text-muted small mb-0"><i class="fas fa-map-marker-alt me-1"></i> Teretana</p>
                        </div>
                    `);
                }
            }

            document.addEventListener('DOMContentLoaded', initMap);
        </script>

        <!-- 3) Stilovi za popup, možete ih staviti i u site.css -->
        <style>
            .map-popup {
                min-width: 200px;
            }
            .map-popup h6 {
                color: #007bff;
                margin-bottom: 5px;
            }
            .leaflet-popup-content {
                margin: 12px;
            }
        </style>

    }
}